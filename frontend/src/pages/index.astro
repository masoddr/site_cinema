---
import SeancesViewer from '../components/SeancesViewer';

// Récupérer les séances depuis l'API
let seances = [];
try {
  const response = await fetch('http://localhost:5000/api/seances', {
    headers: {
      'Accept': 'application/json'
    }
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  const contentType = response.headers.get('content-type');
  if (!contentType || !contentType.includes('application/json')) {
    throw new TypeError("La réponse n'est pas du JSON!");
  }
  
  seances = await response.json();
  console.log('Séances récupérées:', seances);
  
} catch (error) {
  console.error('Erreur lors de la récupération des séances:', error);
  console.error('Message:', error.message);
}

// Normaliser les titres (tout en minuscules)
const normalizeTitle = (title) => title.toLowerCase().trim();

// Ajouter le titre normalisé à chaque séance
const seancesNormalized = seances.map(s => ({
  ...s,
  titreNormalise: normalizeTitle(s.titre)
}));

// Trier les séances
const sortedSeances = seancesNormalized.sort((a, b) => 
  new Date(a.jour) - new Date(b.jour) || 
  a.heure.localeCompare(b.heure)
);
---

<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cinémas Toulouse</title>
  </head>
  <body>
    <h1>Bienvenue sur mon site</h1>
    <main>
      <SeancesViewer client:load seances={sortedSeances} />
    </main>
  </body>
</html> 